___TERMS_OF_SERVICE___

By creating or modifying this file you agree to Google Tag Manager's Community
Template Gallery Developer Terms of Service available at
https://developers.google.com/tag-manager/gallery-tos (or such other URL as
Google may provide), as modified from time to time.


___INFO___

{
  "type": "TAG",
  "id": "cvt_temp_public_id",
  "version": 1,
  "securityGroups": [],
  "displayName": "Yahoo!広告 ConversionAPIタグ",
  "brand": {
    "id": "brand_dummy",
    "displayName": "",
    "thumbnail": "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAEoAAABKCAIAAACTslUmAAAKQWlDQ1BJQ0MgUHJvZmlsZQAASA2dlndUU9kWh8+9N73QEiIgJfQaegkg0jtIFQRRiUmAUAKGhCZ2RAVGFBEpVmRUwAFHhyJjRRQLg4Ji1wnyEFDGwVFEReXdjGsJ7601896a/cdZ39nnt9fZZ+9917oAUPyCBMJ0WAGANKFYFO7rwVwSE8vE9wIYEAEOWAHA4WZmBEf4RALU/L09mZmoSMaz9u4ugGS72yy/UCZz1v9/kSI3QyQGAApF1TY8fiYX5QKUU7PFGTL/BMr0lSkyhjEyFqEJoqwi48SvbPan5iu7yZiXJuShGlnOGbw0noy7UN6aJeGjjAShXJgl4GejfAdlvVRJmgDl9yjT0/icTAAwFJlfzOcmoWyJMkUUGe6J8gIACJTEObxyDov5OWieAHimZ+SKBIlJYqYR15hp5ejIZvrxs1P5YjErlMNN4Yh4TM/0tAyOMBeAr2+WRQElWW2ZaJHtrRzt7VnW5mj5v9nfHn5T/T3IevtV8Sbsz55BjJ5Z32zsrC+9FgD2JFqbHbO+lVUAtG0GQOXhrE/vIADyBQC03pzzHoZsXpLE4gwnC4vs7GxzAZ9rLivoN/ufgm/Kv4Y595nL7vtWO6YXP4EjSRUzZUXlpqemS0TMzAwOl89k/fcQ/+PAOWnNycMsnJ/AF/GF6FVR6JQJhIlou4U8gViQLmQKhH/V4X8YNicHGX6daxRodV8AfYU5ULhJB8hvPQBDIwMkbj96An3rWxAxCsi+vGitka9zjzJ6/uf6Hwtcim7hTEEiU+b2DI9kciWiLBmj34RswQISkAd0oAo0gS4wAixgDRyAM3AD3iAAhIBIEAOWAy5IAmlABLJBPtgACkEx2AF2g2pwANSBetAEToI2cAZcBFfADXALDIBHQAqGwUswAd6BaQiC8BAVokGqkBakD5lC1hAbWgh5Q0FQOBQDxUOJkBCSQPnQJqgYKoOqoUNQPfQjdBq6CF2D+qAH0CA0Bv0BfYQRmALTYQ3YALaA2bA7HAhHwsvgRHgVnAcXwNvhSrgWPg63whfhG/AALIVfwpMIQMgIA9FGWAgb8URCkFgkAREha5EipAKpRZqQDqQbuY1IkXHkAwaHoWGYGBbGGeOHWYzhYlZh1mJKMNWYY5hWTBfmNmYQM4H5gqVi1bGmWCesP3YJNhGbjS3EVmCPYFuwl7ED2GHsOxwOx8AZ4hxwfrgYXDJuNa4Etw/XjLuA68MN4SbxeLwq3hTvgg/Bc/BifCG+Cn8cfx7fjx/GvyeQCVoEa4IPIZYgJGwkVBAaCOcI/YQRwjRRgahPdCKGEHnEXGIpsY7YQbxJHCZOkxRJhiQXUiQpmbSBVElqIl0mPSa9IZPJOmRHchhZQF5PriSfIF8lD5I/UJQoJhRPShxFQtlOOUq5QHlAeUOlUg2obtRYqpi6nVpPvUR9Sn0vR5Mzl/OX48mtk6uRa5Xrl3slT5TXl3eXXy6fJ18hf0r+pvy4AlHBQMFTgaOwVqFG4bTCPYVJRZqilWKIYppiiWKD4jXFUSW8koGStxJPqUDpsNIlpSEaQtOledK4tE20Otpl2jAdRzek+9OT6cX0H+i99AllJWVb5SjlHOUa5bPKUgbCMGD4M1IZpYyTjLuMj/M05rnP48/bNq9pXv+8KZX5Km4qfJUilWaVAZWPqkxVb9UU1Z2qbapP1DBqJmphatlq+9Uuq43Pp893ns+dXzT/5PyH6rC6iXq4+mr1w+o96pMamhq+GhkaVRqXNMY1GZpumsma5ZrnNMe0aFoLtQRa5VrntV4wlZnuzFRmJbOLOaGtru2nLdE+pN2rPa1jqLNYZ6NOs84TXZIuWzdBt1y3U3dCT0svWC9fr1HvoT5Rn62fpL9Hv1t/ysDQINpgi0GbwaihiqG/YZ5ho+FjI6qRq9Eqo1qjO8Y4Y7ZxivE+41smsImdSZJJjclNU9jU3lRgus+0zwxr5mgmNKs1u8eisNxZWaxG1qA5wzzIfKN5m/krCz2LWIudFt0WXyztLFMt6ywfWSlZBVhttOqw+sPaxJprXWN9x4Zq42Ozzqbd5rWtqS3fdr/tfTuaXbDdFrtOu8/2DvYi+yb7MQc9h3iHvQ732HR2KLuEfdUR6+jhuM7xjOMHJ3snsdNJp9+dWc4pzg3OowsMF/AX1C0YctFx4bgccpEuZC6MX3hwodRV25XjWuv6zE3Xjed2xG3E3dg92f24+ysPSw+RR4vHlKeT5xrPC16Il69XkVevt5L3Yu9q76c+Oj6JPo0+E752vqt9L/hh/QL9dvrd89fw5/rX+08EOASsCegKpARGBFYHPgsyCRIFdQTDwQHBu4IfL9JfJFzUFgJC/EN2hTwJNQxdFfpzGC4sNKwm7Hm4VXh+eHcELWJFREPEu0iPyNLIR4uNFksWd0bJR8VF1UdNRXtFl0VLl1gsWbPkRoxajCCmPRYfGxV7JHZyqffS3UuH4+ziCuPuLjNclrPs2nK15anLz66QX8FZcSoeGx8d3xD/iRPCqeVMrvRfuXflBNeTu4f7kufGK+eN8V34ZfyRBJeEsoTRRJfEXYljSa5JFUnjAk9BteB1sl/ygeSplJCUoykzqdGpzWmEtPi000IlYYqwK10zPSe9L8M0ozBDuspp1e5VE6JA0ZFMKHNZZruYjv5M9UiMJJslg1kLs2qy3mdHZZ/KUcwR5vTkmuRuyx3J88n7fjVmNXd1Z752/ob8wTXuaw6thdauXNu5Tnddwbrh9b7rj20gbUjZ8MtGy41lG99uit7UUaBRsL5gaLPv5sZCuUJR4b0tzlsObMVsFWzt3WazrWrblyJe0fViy+KK4k8l3JLr31l9V/ndzPaE7b2l9qX7d+B2CHfc3em681iZYlle2dCu4F2t5czyovK3u1fsvlZhW3FgD2mPZI+0MqiyvUqvakfVp+qk6oEaj5rmvep7t+2d2sfb17/fbX/TAY0DxQc+HhQcvH/I91BrrUFtxWHc4azDz+ui6rq/Z39ff0TtSPGRz0eFR6XHwo911TvU1zeoN5Q2wo2SxrHjccdv/eD1Q3sTq+lQM6O5+AQ4ITnx4sf4H++eDDzZeYp9qukn/Z/2ttBailqh1tzWibakNml7THvf6YDTnR3OHS0/m/989Iz2mZqzymdLz5HOFZybOZ93fvJCxoXxi4kXhzpXdD66tOTSna6wrt7LgZevXvG5cqnbvfv8VZerZ645XTt9nX297Yb9jdYeu56WX+x+aem172296XCz/ZbjrY6+BX3n+l37L972un3ljv+dGwOLBvruLr57/17cPel93v3RB6kPXj/Mejj9aP1j7OOiJwpPKp6qP6391fjXZqm99Oyg12DPs4hnj4a4Qy//lfmvT8MFz6nPK0a0RupHrUfPjPmM3Xqx9MXwy4yX0+OFvyn+tveV0auffnf7vWdiycTwa9HrmT9K3qi+OfrW9m3nZOjk03dp76anit6rvj/2gf2h+2P0x5Hp7E/4T5WfjT93fAn88ngmbWbm3/eE8/syOll+AAAGQUlEQVR4Ae1aCVCUVRz/LZAtcgiGYopCpHhQlmaKplhjhDiNymjl1WSmpSWWVh6gzWigwUjaiCiWQ3jknQNOOqWZGWaamleFqeVBHg2WpLg7Diz93+7nHt/3dr+DdeaL+f6zM7z3v977vd/bd7Gm+vp6NF4JaLzQGDID3v+ZX4M9gz3djoAxOXVLjYKOGewpGCTduhjs6ZYaBR0z2FMwSLp1MdjTLTUKOmawp2CQdOvSyNkLEg984vP45XexUkN97kS8N15DnH9DJOxdvOqfBh5u7588DctiEr+Urd6O3y7gbKXwuXZdJn9YCJ5Jwv1RaBmJyHD7JwzR91kT48xms0zs3TdL4Ima/OcGTp1HcRlWfC6yCNWgIOwvRo/OfOvd0O4/gan5GNwfQ/ojMd53C3LwnNGzCvDBp86aR6FjHA6vQYgCribn4c+/PGKVV3p0QdY45j5jCfJKhLj4GAxOJpy1fR8JooGWiGJ4FPlGLgo3STLYFRPSsSKLb3LXDnkbZd+6K5SWQ4JxZC0S2jH/zsNRcU4c2LwZ0vowPp972t2kAl5dXV3giCxs3uUe7yqvX4AXUlxVbunYafxwAn9cwpmL7ENfcouV6ygo27ZCz0R074QBj6PXQ0x5+iIS0r2GjEjFuhx3qwp4FGaxWIJTMrDvqHsKodwslA1wfBuOyYvKZrMFrP8Ko2d72GmOjR+K1CSGh1YskSxcg3cXi3RCNTwUFZtFIZKNgR8qaIODg7F1IR7gYai+ieEzrFafbHgmD6iuwbxPPHRd4vHjKiybiaFPijoquPmY29mTpCHq4LE2WkRg+0cgrqTyU4X5rUVSNV9Dw5GWgVPnXNbXhlkOleDRBJdGVKq6ju+Pi3RCtWuH2knDpCb18ChHpzjQNy0wUJoORVtAO6esXKpCv/E4cFJwDG2Kz3KwfBabHT7ki3LU1fHtS6ZzV05N8KiFgb2Rm8FvaeJ8nDzLNzm0tMAkjcWJM4JPQiwOlGBkqq8Qh63Uy6pLK0pyN264uqVFnGLMHKzdIVZSvUM79hXiTuCyvWwtuXlLiHq2H1a/jwjeVPfMS99qc1QKaiyeaoD2jIotiGkp1tvrWtmzB1s+zkS3Tpy8py/g5bmi4x6rzi9G+jsubDPH2krzlWCjJsy7D3OwkSFznDdsZGwQPGEhpS1VKlu/MeWvdalvWU0jMpG1FDYbUza5B6vmYcHkgADFHeDOzAdjrNNGulqRlBRnl0QKithWbFXg9pLOcfuOMTfHQrJxpxASEYadhXhxkFBV8Icxv20vx/HDab4P7g2GR23SFjyHd7WrrQUxRgh7vYQjFULnYqJRvtLbSsABYFeZDv2Ky1Vi68A+7MDpUxq2tNxJzc5rqRn4+uAdhdtfkwnOXye0b4svC1SdbIREs5chZ6VbUvv0Pr4eHWM9lJKKP9gDbYGBWD0PURGS/HBhI952L9eCjZJKDytvjpTFRnH+gcdQ0fmwcCYrcIXWkm2L0Daaa5RR0hHcuUk6XKmt2a/IRNnN/oNH6egy0roFv9Xk7r5OW/yYO1raKkWSOwXhISIdt+pXeNQCscSVUJ+nLW6IU1m6x1lkhd5d68ekeWi8V/wNz3tLGi30GvKd2/2LdqCC6SZarpSJ7uHt2AfaYJxCV0G63SoW3cMb0BNFWRjUF+Z72TNc9uuKoTFHzvOLqvi77hzdHK+ms89NCyqvstumGtE9e04wtDjRPVOl+BterZfr5r81qjp2+/ZtFGzE1b9VRUmd/Qrv3GXOydDRpk3dr0abbNiFjDy0SUPaFCzdxN7UNIl/zpw4fwXby9k774Ur/G7EtcbUUcIrffNw0KUhMswaGer1vP/YGNcp3JGRDnRP9eAn967VCu9MJSZks8sbPe/Qf11uqJt7Qn+amlFTzulb+VH2EuMuXeLrT25Qvt05Q7WunPSasOeQM4vGgvQZ05Fo8TpxwqmjNGCjJFq/e3T4ahEp7oTaetcO/IiiTGzOw6ThaNeKOURFWEYreGji5dI6OXm5/K6jS7rp4M+4Vo1BT2hLrmt42iC5R2mdnO45dFw24OmYHNmuGezJDpGOHQz2dEyObNcM9mSHSMcOBns6Jke2awZ7skOkYweDPR2TI9s1gz3ZIdKxg8GejsmR7dp/NayY/0q1OhAAAAAASUVORK5CYII\u003d"
  },
  "description": "Yahoo!広告のConversionAPI用タグです。 ※設定について注意点があります。下の「リンク」にある「ドキュメント」をクリックしてご確認ください。",
  "categories": [
    "ADVERTISING",
    "MARKETING",
    "CONVERSIONS"
  ],
  "containerContexts": [
    "SERVER"
  ]
}


___TEMPLATE_PARAMETERS___

[
  {
    "type": "LABEL",
    "name": "notice",
    "displayName": "\u003ca href\u003d\"https://github.com/yahoojp-marketing/ads-data-management-api-documents/blob/main/docs_ja/conversion-api-tag.md\"\u003e設定について注意点があります。ドキュメントの「注意点」をご確認の上ご利用ください。\u003c/a\u003e"
  },
  {
    "type": "TEXT",
    "name": "app_id",
    "displayName": "アプリケーションID(Client ID)",
    "simpleValueType": true,
    "valueValidators": [
      {
        "type": "NON_EMPTY"
      }
    ],
    "help": "Yahoo!デベロッパーネットワークで取得したアプリケーションID(Client ID)を指定してください。"
  },
  {
    "type": "TEXT",
    "name": "hashed_email",
    "simpleValueType": true,
    "displayName": "hashed_email",
    "help": "SHA-256でハッシュ化されたEメール。半角小文字英数字で入力してください。"
  },
  {
    "type": "TEXT",
    "name": "hashed_phone_number",
    "simpleValueType": true,
    "displayName": "hashed_phone_number",
    "help": "SHA-256でハッシュ化されたハイフン無し半角数字の電話番号。半角小文字英数字で入力してください。"
  },
  {
    "type": "TEXT",
    "name": "yclid",
    "simpleValueType": true,
    "displayName": "yclid",
    "help": "広告をクリックしたユーザーを識別するパラメータ。_ycl_yjad Cookie の値を入力してください。"
  },
  {
    "type": "TEXT",
    "name": "yjr_yjad",
    "simpleValueType": true,
    "displayName": "yjr_yjad",
    "help": "広告をクリックしたユーザーを識別するパラメータ。_yjr_yjad Cookie の値を入力してください。"
  },
  {
    "type": "TEXT",
    "name": "event_time",
    "simpleValueType": true,
    "displayName": "event_time",
    "help": "コンバージョンの発生日時。リクエスト日時より90日前〜現在時刻の間の10桁UNIX時間で入力してください。"
  },
  {
    "type": "TEXT",
    "name": "yahoo_ydn_conv_io",
    "simpleValueType": true,
    "displayName": "yahoo_ydn_conv_io",
    "valueValidators": [
      {
        "type": "NON_EMPTY"
      }
    ],
    "help": "お客様のアカウント専用の値。広告管理ツールで取得した「Conversion API リクエストパラメータ」の yahoo_ydn_conv_io の値をそのまま入力してください。"
  },
  {
    "type": "TEXT",
    "name": "yahoo_ydn_conv_label",
    "displayName": "yahoo_ydn_conv_label",
    "simpleValueType": true,
    "valueValidators": [
      {
        "type": "NON_EMPTY"
      }
    ],
    "help": "コンバージョンタグにおいてタグを識別するための項目。広告管理ツールで取得した「Conversion API リクエストパラメータ」の yahoo_ydn_conv_label の値をそのまま入力してください。"
  },
  {
    "type": "TEXT",
    "name": "yahoo_ydn_conv_transaction_id",
    "displayName": "yahoo_ydn_conv_transaction_id",
    "simpleValueType": true,
    "help": "コンバージョンの重複判定をするためのユニークなID。64byteを超えない範囲で、かつ前後にスペースが入らないように入力してください。"
  },
  {
    "type": "TEXT",
    "name": "yahoo_ydn_conv_value",
    "simpleValueType": true,
    "displayName": "yahoo_ydn_conv_value",
    "help": "1コンバージョンあたりの価値。広告管理ツールで取得した「Conversion API リクエストパラメータ」の yahoo_ydn_conv_value の値、もしくは任意の値を入力してください。"
  }
]


___SANDBOXED_JS_FOR_SERVER___

const JSON = require('JSON');
const Math = require('Math');
const getEventData = require('getEventData');
const getCookieValues = require('getCookieValues');
const getTimestampMillis = require('getTimestampMillis');
const sha256Sync = require('sha256Sync');
const sendHttpRequest = require('sendHttpRequest');
const logToConsole = require('logToConsole');

const CVAPI_ENDPOINT = 'https://ads-cv.yahooapis.jp/v1';
const CVAPI_REQUEST_HEADERS = {
  method: 'POST',
  headers: { 'content-type': 'application/json', 'User-Agent': 'Yahoo AppID:' + data.app_id }
};

function isHashed(input) {
  return input != null && (input.match('^[0-9a-fA-F]{64}$') != null);
}

function convertToHash(input) {
  return sha256Sync(input.trim().toLowerCase(), { outputEncoding: 'hex' }).toLowerCase();
}

function getHashedEmail(input) {
  if (input == null) return undefined;

  if (isHashed(input)) {
    return input.toLowerCase();
  }

  if (input.match('^\\S+@\\S+\\.\\S+$') != null) {
    return convertToHash(input);
  }
  return undefined;
}

function getHashedPhoneNumber(input) {
  if (input == null) return undefined;

  if (isHashed(input)) {
    return input.toLowerCase();
  }

  input = input.split('-').join('').replace('+81', '0');
  if (input.match('^\\d+$') != null) {
    return convertToHash(input);
  }
  return undefined;
}

function buildRequestBody() {
  const body = {};
  body.hashed_email = getHashedEmail(data.hashed_email) || getHashedEmail(getEventData('user_data.email_address'));
  body.hashed_phone_number = getHashedPhoneNumber(data.hashed_phone_number) || getHashedPhoneNumber(getEventData('user_data.phone_number'));
  body.yclid = data.yclid || getCookieValues('_ycl_yjad')[0];
  body.yjr_yjad = data.yjr_yjad || getCookieValues('_yjr_yjad')[0];
  body.event_time = data.event_time || Math.floor(getTimestampMillis() / 1000);
  body.yahoo_ydn_conv_io = data.yahoo_ydn_conv_io;
  body.yahoo_ydn_conv_label = data.yahoo_ydn_conv_label;
  body.yahoo_ydn_conv_transaction_id = data.yahoo_ydn_conv_transaction_id;
  body.yahoo_ydn_conv_value = data.yahoo_ydn_conv_value;
  body._s = 'ssgtm';
  return body;
}

const cvapiRequestBody = buildRequestBody();

sendHttpRequest(
  CVAPI_ENDPOINT,
  (status, headers, response) => {
    if (status == 201) {
      logToConsole('success: ' + JSON.stringify(cvapiRequestBody));
      data.gtmOnSuccess();
    } else {
      logToConsole('failure: ' + JSON.stringify(cvapiRequestBody));
      data.gtmOnFailure();
    }
  },
  CVAPI_REQUEST_HEADERS,
  JSON.stringify(cvapiRequestBody)
);


___SERVER_PERMISSIONS___

[
  {
    "instance": {
      "key": {
        "publicId": "send_http",
        "versionId": "1"
      },
      "param": [
        {
          "key": "allowedUrls",
          "value": {
            "type": 1,
            "string": "specific"
          }
        },
        {
          "key": "urls",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 1,
                "string": "https://ads-cv.yahooapis.jp/v1"
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "get_cookies",
        "versionId": "1"
      },
      "param": [
        {
          "key": "cookieAccess",
          "value": {
            "type": 1,
            "string": "specific"
          }
        },
        {
          "key": "cookieNames",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 1,
                "string": "_ycl_yjad"
              },
              {
                "type": 1,
                "string": "_yjr_yjad"
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "read_event_data",
        "versionId": "1"
      },
      "param": [
        {
          "key": "keyPatterns",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 1,
                "string": "user_data.email_address"
              },
              {
                "type": 1,
                "string": "user_data.phone_number"
              }
            ]
          }
        },
        {
          "key": "eventDataAccess",
          "value": {
            "type": 1,
            "string": "specific"
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "logging",
        "versionId": "1"
      },
      "param": [
        {
          "key": "environments",
          "value": {
            "type": 1,
            "string": "debug"
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  }
]


___TESTS___

scenarios:
- name: testSuccess
  code: |
    // Prepare
    runCode(baseData);

    // Verify
    assertThat(JSON.parse(reqestBody)).isEqualTo(expectedReqestBody);
    assertThat(Object.keys(JSON.parse(reqestBody)).length).isEqualTo(10);
    assertApi('gtmOnSuccess').wasCalled();
- name: testFailure
  code: |-
    // Prepare
    mock('sendHttpRequest', (uri, response, options, body) => {
      callback = response;
      reqestBody = body;
      callback(400, '', '');
    });

    runCode({});

    // Verify
    assertApi('gtmOnFailure').wasCalled();
- name: testUnhashedEmail
  code: |
    // Prepare
    baseData.hashed_email = 'example@example.com';
    baseData.hashed_phone_number = undefined;
    mock('getEventData', (name) => {
      return undefined;
    });
    runCode(baseData);

    // Verify
    const expected = {
      'hashed_email': '31c5543c1734d25c7206f5fd591525d0295bec6fe84ff82f946a34fe970a1e66',
      'yclid': baseData.yclid,
      'yjr_yjad': baseData.yjr_yjad,
      'event_time': baseData.event_time,
      'yahoo_ydn_conv_io': baseData.yahoo_ydn_conv_io,
      'yahoo_ydn_conv_label': baseData.yahoo_ydn_conv_label,
      'yahoo_ydn_conv_transaction_id': baseData.yahoo_ydn_conv_transaction_id,
      'yahoo_ydn_conv_value': baseData.yahoo_ydn_conv_value,
      '_s': baseData._s
    };

    assertThat(JSON.parse(reqestBody)).isEqualTo(expected);
    assertThat(Object.keys(JSON.parse(reqestBody)).length).isEqualTo(9);
    assertApi('gtmOnSuccess').wasCalled();
- name: testInvalidEmail
  code: |
    // Prepare
    baseData.hashed_email = 'example';
    mock('getEventData', (name) => {
      return undefined;
    });
    runCode(baseData);

    // Verify
    const expected = {
      'hashed_phone_number': baseData.hashed_phone_number,
      'yclid': baseData.yclid,
      'yjr_yjad': baseData.yjr_yjad,
      'event_time': baseData.event_time,
      'yahoo_ydn_conv_io': baseData.yahoo_ydn_conv_io,
      'yahoo_ydn_conv_label': baseData.yahoo_ydn_conv_label,
      'yahoo_ydn_conv_transaction_id': baseData.yahoo_ydn_conv_transaction_id,
      'yahoo_ydn_conv_value': baseData.yahoo_ydn_conv_value,
      '_s': baseData._s
    };

    assertThat(JSON.parse(reqestBody)).isEqualTo(expected);
    assertThat(Object.keys(JSON.parse(reqestBody)).length).isEqualTo(9);
    assertApi('gtmOnSuccess').wasCalled();
- name: testUnhashedPhoneNumber1
  code: |
    // Prepare
    baseData.hashed_email = undefined;
    baseData.hashed_phone_number = '+8190-0000-0000';
    mock('getEventData', (name) => {
      return undefined;
    });
    runCode(baseData);

    // Verify
    const expected = {
      'hashed_phone_number': '209ba2f6449a60575543fa2e1ee574cbea59f0b946ad70732a31ec2c53d23be5',
      'yclid': baseData.yclid,
      'yjr_yjad': baseData.yjr_yjad,
      'event_time': baseData.event_time,
      'yahoo_ydn_conv_io': baseData.yahoo_ydn_conv_io,
      'yahoo_ydn_conv_label': baseData.yahoo_ydn_conv_label,
      'yahoo_ydn_conv_transaction_id': baseData.yahoo_ydn_conv_transaction_id,
      'yahoo_ydn_conv_value': baseData.yahoo_ydn_conv_value,
      '_s': baseData._s
    };

    assertThat(JSON.parse(reqestBody)).isEqualTo(expected);
    assertThat(Object.keys(JSON.parse(reqestBody)).length).isEqualTo(9);
    assertApi('gtmOnSuccess').wasCalled();
- name: testUnhashedPhoneNumber2
  code: |
    // Prepare
    baseData.hashed_email = undefined;
    baseData.hashed_phone_number = '09000000000';
    mock('getEventData', (name) => {
      return undefined;
    });
    runCode(baseData);

    // Verify
    const expected = {
      'hashed_phone_number': '209ba2f6449a60575543fa2e1ee574cbea59f0b946ad70732a31ec2c53d23be5',
      'yclid': baseData.yclid,
      'yjr_yjad': baseData.yjr_yjad,
      'event_time': baseData.event_time,
      'yahoo_ydn_conv_io': baseData.yahoo_ydn_conv_io,
      'yahoo_ydn_conv_label': baseData.yahoo_ydn_conv_label,
      'yahoo_ydn_conv_transaction_id': baseData.yahoo_ydn_conv_transaction_id,
      'yahoo_ydn_conv_value': baseData.yahoo_ydn_conv_value,
      '_s': baseData._s
    };

    assertThat(JSON.parse(reqestBody)).isEqualTo(expected);
    assertThat(Object.keys(JSON.parse(reqestBody)).length).isEqualTo(9);
    assertApi('gtmOnSuccess').wasCalled();
- name: testInvalidPhoneNumber
  code: |
    // Prepare
    baseData.hashed_phone_number = '0a0-0000-0000';
    mock('getEventData', (name) => {
      return undefined;
    });
    runCode(baseData);

    // Verify
    const expected = {
      'hashed_email': baseData.hashed_email,
      'yclid': baseData.yclid,
      'yjr_yjad': baseData.yjr_yjad,
      'event_time': baseData.event_time,
      'yahoo_ydn_conv_io': baseData.yahoo_ydn_conv_io,
      'yahoo_ydn_conv_label': baseData.yahoo_ydn_conv_label,
      'yahoo_ydn_conv_transaction_id': baseData.yahoo_ydn_conv_transaction_id,
      'yahoo_ydn_conv_value': baseData.yahoo_ydn_conv_value,
      '_s': baseData._s
    };

    assertThat(JSON.parse(reqestBody)).isEqualTo(expected);
    assertThat(Object.keys(JSON.parse(reqestBody)).length).isEqualTo(9);
    assertApi('gtmOnSuccess').wasCalled();
- name: testGetValuesFromEventData
  code: |
    // Prepare
    baseData.hashed_email = undefined;
    baseData.hashed_phone_number = undefined;
    runCode(baseData);

    // Verify
    const expected = {
      'hashed_email': '274e44d98f150bdaff591268419d09f488c22a617e34e15434e5ac1f8db3b216',
      'hashed_phone_number': '209ba2f6449a60575543fa2e1ee574cbea59f0b946ad70732a31ec2c53d23be5',
      'yclid': baseData.yclid,
      'yjr_yjad': baseData.yjr_yjad,
      'event_time': baseData.event_time,
      'yahoo_ydn_conv_io': baseData.yahoo_ydn_conv_io,
      'yahoo_ydn_conv_label': baseData.yahoo_ydn_conv_label,
      'yahoo_ydn_conv_transaction_id': baseData.yahoo_ydn_conv_transaction_id,
      'yahoo_ydn_conv_value': baseData.yahoo_ydn_conv_value,
      '_s': baseData._s
    };

    assertThat(JSON.parse(reqestBody)).isEqualTo(expected);
    assertThat(Object.keys(JSON.parse(reqestBody)).length).isEqualTo(10);
    assertApi('gtmOnSuccess').wasCalled();
- name: testGetValuesFromCookie
  code: |
    // Prepare
    baseData.yclid = undefined;
    baseData.yjr_yjad = undefined;
    runCode(baseData);

    // Verify
    const expected = {
      'hashed_email': baseData.hashed_email,
      'hashed_phone_number': baseData.hashed_phone_number,
      'yclid': 'ycl_cookie_value',
      'yjr_yjad': 'yjr_cookie_value',
      'event_time': baseData.event_time,
      'yahoo_ydn_conv_io': baseData.yahoo_ydn_conv_io,
      'yahoo_ydn_conv_label': baseData.yahoo_ydn_conv_label,
      'yahoo_ydn_conv_transaction_id': baseData.yahoo_ydn_conv_transaction_id,
      'yahoo_ydn_conv_value': baseData.yahoo_ydn_conv_value,
      '_s': baseData._s
    };

    assertThat(JSON.parse(reqestBody)).isEqualTo(expected);
    assertThat(Object.keys(JSON.parse(reqestBody)).length).isEqualTo(10);
    assertApi('gtmOnSuccess').wasCalled();
setup: "const JSON = require('JSON');\nconst Object = require('Object');\nconst logToConsole\
  \ = require('logToConsole');\n\nconst cvapiEndpoint = 'https://ads-cv.yahooapis.jp/v1';\n\
  const cvapiReqestHeaders = {\n  method: 'POST',\n  headers: {'content-type': 'application/json',\
  \ 'User-Agent': 'Yahoo AppID:'+data.app_id}\n};\n\nconst baseData = {\n  app_id:\
  \ 'test_app_id',\n  hashed_email: '31c5543c1734d25c7206f5fd591525d0295bec6fe84ff82f946a34fe970a1e66',\n\
  \  hashed_phone_number: '4e6a6c5c6f8a086ce4babac3247364cc93a8a995a1968105d9b408f7e6b72e51',\n\
  \  yclid: 'YJAD.1234567890.1EALEzSJBNabcdEFGBE1',\n  yjr_yjad: '1600000000.f0',\n\
  \  event_time: 1600000000,\n  yahoo_ydn_conv_io: '1EALEzSJBNabcdEFGBE1',\n  yahoo_ydn_conv_label:\
  \ 'AB0ABCDEFGHIJKLMNOP123456',\n  yahoo_ydn_conv_transaction_id: 'order1234', \n\
  \  yahoo_ydn_conv_value: 5,\n  _s: 'ssgtm'\n};\n\nmock('getEventData', (name) =>\
  \ {\n  // 274e44d98f150bdaff591268419d09f488c22a617e34e15434e5ac1f8db3b216\n  if(name\
  \ === 'user_data.email_address') return 'example2@example.com';\n  // 209ba2f6449a60575543fa2e1ee574cbea59f0b946ad70732a31ec2c53d23be5\n\
  \  if(name === 'user_data.phone_number') return '+819000000000';\n});\n\nmock('getTimestampMillis',\
  \ () => {\n  return 1665900000123;\n});\n\nmock('getCookieValues', (name) => {\n\
  \  if(name === '_ycl_yjad') return ['ycl_cookie_value'];\n  if(name === '_yjr_yjad')\
  \ return ['yjr_cookie_value'];\n});\n\nconst expectedReqestBody = {\n  'hashed_email':\
  \ baseData.hashed_email,\n  'hashed_phone_number': baseData.hashed_phone_number,\n\
  \  'yclid': baseData.yclid,\n  'yjr_yjad': baseData.yjr_yjad,\n  'event_time': baseData.event_time,\n\
  \  'yahoo_ydn_conv_io': baseData.yahoo_ydn_conv_io,\n  'yahoo_ydn_conv_label': baseData.yahoo_ydn_conv_label,\n\
  \  'yahoo_ydn_conv_transaction_id': baseData.yahoo_ydn_conv_transaction_id,\n  'yahoo_ydn_conv_value':\
  \ baseData.yahoo_ydn_conv_value,\n  '_s': 'ssgtm'\n};\n\nlet callback, reqestBody;\n\
  mock('sendHttpRequest', (uri, response, options, body) => {\n  callback = response;\n\
  \  reqestBody = body;\n  callback(201, '', '');\n});"


___NOTES___

Created on 2022/11/2 11:54:42


